---
import FeedLayout from "../../../layouts/Feed.astro";
import { getAllAuthors, getAllCheeps, getAllTags, getSiteConfig } from "../../../constants/queries.js";
import { ROUTES } from '../../../constants/routes.js'

export async function getStaticPaths({ paginate }) {
  const { PAGINATION_SIZE } = import.meta.env
  const pageSize = parseInt(PAGINATION_SIZE, 10)

  const allCheeps = await getAllCheeps()
  const allTags = await getAllTags()
  const siteConfig = await getSiteConfig()
  const allAuthors = await getAllAuthors()

  return allTags.map((tag) => {
    const tagName = tag.title

    const filteredCheeps = allCheeps.filter(
      (cheep) => {
        const cheepTags = cheep.tags.filter(t => t !== null)
        // if (!cheepTags.length) return false
        let tags = [...cheepTags]
        if (cheep.article) {
          for (const article of cheep.article) {
            // Add related tags from an article
            if (article.tags) {
              for (const tag of article.tags) {
                if(!tags.find(t => t._id === tag._id)) tags.push(tag)
              }
            }
          }
        }
        if (tags.find(tag => tag.title === tagName)) return true
        return false
      }
    )
    
    // If there's a specialty character, show them
    let character = siteConfig.character
    const specialtyIndex = allAuthors.findIndex(author => author?.specialty?.title === tagName )
    if (specialtyIndex !== -1)
      character = allAuthors[specialtyIndex]

    return {
      params: {
        tag: tagName.toLowerCase(),
      },
      props: {
        page: {
          character,
          tagLabel: tagName,
          posts: filteredCheeps.slice(0, pageSize),
          currentPage: 1,
          totalPages: Math.ceil(filteredCheeps.length / pageSize),
          route: `${ROUTES.posts.href}/${tagName.toLowerCase()}`
        }
      },
    }
  });
}

const { banner, character, tagLabel, page } = Astro.props
---
<FeedLayout
  title={`${tagLabel} posts from Jhey Tompkins`}
  ogtitle={`${tagLabel} posts from Jhey Tompkins`}
  description={`A collection of posts from Jhey all about ${tagLabel}`}
  oggradient="8"
  page={page}
/>