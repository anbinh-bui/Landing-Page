---
import Layout from "../../../layouts/Layout.astro";
import FeedLayout from "../../../components/feed-layout/feed-layout.jsx";

export async function getStaticPaths({ paginate }) {
  const { SANITY_STUDIO_PROJECT_ID, SANITY_STUDIO_PROJECT_DATASET, PAGINATION_SIZE } = import.meta.env
  const pageSize = parseInt(PAGINATION_SIZE, 10)

  const CONFIG_QUERY = encodeURIComponent('*[_type == "config"]{...,character->{"avatar": image.asset->url, ...}}');
  const CONFIG_URL = `https://${SANITY_STUDIO_PROJECT_ID}.api.sanity.io/v2021-10-21/data/query/${SANITY_STUDIO_PROJECT_DATASET}?query=${CONFIG_QUERY}`;

  const TAG_QUERY = encodeURIComponent('*[_type == "tag"]')
  const TAG_URL = `https://${SANITY_STUDIO_PROJECT_ID}.api.sanity.io/v2021-10-21/data/query/${SANITY_STUDIO_PROJECT_DATASET}?query=${TAG_QUERY}`;
  const CHEEP_QUERY = encodeURIComponent('*[_type == "cheep"]{...,article[]->{tags[]->{...}}, tags[]->{...},author->{"avatar": image.asset->url, ...}} | order(publishedAt desc)');
  const CHEEP_URL = `https://${SANITY_STUDIO_PROJECT_ID}.api.sanity.io/v2021-10-21/data/query/${SANITY_STUDIO_PROJECT_DATASET}?query=${CHEEP_QUERY}`;

  const allTags = await (await (await fetch(TAG_URL)).json()).result

  // Cheeps have tags by association of related articles??
  const allCheeps = await (await (await fetch(CHEEP_URL)).json()).result
  const siteConfig = await (await (await fetch(CONFIG_URL)).json()).result

  return allTags.map((tag) => {
    const tagName = tag.title

    const filteredCheeps = allCheeps.filter(
      (cheep) => {
        if (!cheep.tags) return false
        if (cheep.tags.length) {
          let tags = [...cheep.tags]
          if (cheep.article) {
            for (const article of cheep.article) {
              // Add related tags from an article
              if (article.tags) {
                for (const tag of article.tags) {
                  if(!tags.find(t => t._id === tag._id)) tags.push(tag)
                }
              }
            }
          }
          if (tags.find(tag => tag.title === tagName)) return true
        }
      }
    )
    
    // Cut this by pagination size and set up the links for the next ones...
    return {
      params: {
        tag: tagName.toLowerCase(),
      },
      props: {
        character: siteConfig[0].character,
        banner: siteConfig[0].banner,
        tagLabel: tagName,
        page: {
          data: filteredCheeps.slice(0, pageSize),
          currentPage: 1,
          lastPage: Math.ceil(filteredCheeps.length / pageSize)
        }
      },
    }
  });
}

const params = Astro.params
const { banner, character, page, tagLabel } = Astro.props
---
<Layout
  title="Jhey Tompkins"
  ogtitle={`${tagLabel} posts from Jhey Tompkins`}
  oggradient="8"
>
  <FeedLayout
    character={character}
    banner={banner}
    posts={page.data}
    category={tagLabel}
    currentPage={page.currentPage}
    totalPages={page.lastPage}
    route={`/posts/${params.tag}`}
  />
</Layout>