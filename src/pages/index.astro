---
import Layout from "../layouts/Layout.astro";
import FeedLayout from "../components/feed-layout/feed-layout.jsx";

const { SANITY_STUDIO_PROJECT_ID, SANITY_STUDIO_PROJECT_DATASET, PAGINATION_SIZE } = import.meta.env
const pageSize = parseInt(PAGINATION_SIZE, 10)

const CHEEP_QUERY = encodeURIComponent('*[_type == "cheep"]{..., author->{"avatar": image.asset->url, ...}} | order(publishedAt desc)');
const CHEEP_URL = `https://${SANITY_STUDIO_PROJECT_ID}.api.sanity.io/v2021-10-21/data/query/${SANITY_STUDIO_PROJECT_DATASET}?query=${CHEEP_QUERY}`;

const allCheeps = await (await (await fetch(CHEEP_URL)).json()).result

const CONFIG_QUERY = encodeURIComponent('*[_type == "config"]{...,character->{"avatar": image.asset->url, ...}}');
const CONFIG_URL = `https://${SANITY_STUDIO_PROJECT_ID}.api.sanity.io/v2021-10-21/data/query/${SANITY_STUDIO_PROJECT_DATASET}?query=${CONFIG_QUERY}`;

const siteConfig = await (await (await fetch(CONFIG_URL)).json()).result

const page = {
  character: siteConfig[0].character,
  banner: siteConfig[0].banner,
  data: allCheeps.slice(0, pageSize),
  currentPage: 1,
  lastPage: Math.ceil(allCheeps.length / pageSize),
}
---

<Layout
  title="Jhey Tompkins"
  ogtitle="The feed of Jhey Tompkins"
  oggradient="8"
>
  <FeedLayout
    banner={page.banner}
    character={page.character}
    posts={page.data}
    currentPage={page.currentPage}
    totalPages={page.lastPage}
  />
</Layout>